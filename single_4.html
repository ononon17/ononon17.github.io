<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æµè§ˆé¡µé¢ - å•åˆ—æ²‰æµ¸å¼å®éªŒ</title>
<style>
/* --- å…¨å±€æ ·å¼ --- */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{background-color:#000;color:#333;font-family:-apple-system, Helvetica, sans-serif; overflow: hidden; height: 100vh; width: 100vw; position: fixed;}

/* å¯åŠ¨è’™å±‚ï¼ˆè§£å†³è‡ªåŠ¨æ’­æ”¾å£°éŸ³çš„å…³é”®ï¼‰ */
#start-mask {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; z-index: 9999;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    color: #fff;
}
#start-btn {
    padding: 15px 40px; background: #fe2c55; border: none; border-radius: 4px;
    color: #fff; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer;
}

#fullscreen-page-container { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 2; background-color:#000; 
    scroll-snap-type: y mandatory; /* å¼ºåˆ¶å¸é™„ */
    overflow-y: scroll; 
    height: 100vh;
}
#fullscreen-page-container::-webkit-scrollbar { display: none; }

.fs-video-item { 
    position:relative; width:100vw; height:100vh; 
    scroll-snap-align: start; scroll-snap-stop: always; 
    display:flex; justify-content:center; align-items:center; background:#000; 
}
.fs-video-item video { width:100%; height:100%; object-fit:cover; background: #000; display: block;}

/* åŠ è½½åŠ¨ç”» */
.loading-spinner {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 40px; height: 40px;
    border: 4px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 4px solid #fff;
    animation: spin 1s linear infinite; z-index: 4; display: none;
}
@keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

/* äº¤äº’å±‚ UI */
.click-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
.overlay { position:absolute; bottom:0; left:0; width:100%; padding:40px 15px; background:linear-gradient(to top, rgba(0,0,0,0.8), transparent); pointer-events:none; color:#fff; z-index: 2;}
.sidebar-fs { position:absolute; right:10px; bottom:120px; display:flex; flex-direction:column; gap:22px; pointer-events:auto; z-index: 10;}

/* æŒ‰é’®ä¸çº¢å¿ƒ */
.icon-btn-fs { 
    width:48px; height:48px; background:rgba(255,255,255,0.15); border-radius:50%; 
    display:flex; justify-content:center; align-items:center; font-size:22px; 
    backdrop-filter:blur(10px); color: #ffffff; cursor:pointer;
    transition: transform 0.1s, color 0.2s; 
}
.icon-btn-fs:active { transform: scale(0.85); background:rgba(255,255,255,0.3); }
.heart-btn.liked { color: #ff2442 !important; animation: heartBeat 0.3s ease-in-out; }
@keyframes heartBeat { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

/* ç»“æŸæŒ‰é’® */
.floating-finish-btn { position: fixed; right: 20px; bottom: 30px; z-index: 999; width: 55px; height: 55px; background: #25D366; color: white; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
.floating-finish-btn:active { transform: scale(0.9); }

/* å¼¹çª— */
#result-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center; }
.modal-content { background: #fff; padding: 30px; border-radius: 15px; width: 85%; max-width: 320px; text-align: center; position: relative; }
.close-modal-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; color: #999; cursor: pointer; line-height: 1; padding: 5px; }
.code-box { background: #f0f0f0; padding: 15px; margin: 15px 0; font-weight: bold; font-size: 18px; word-break: break-all; border-radius: 8px; border: 1px dashed #ccc;}
</style>
</head>
<body>

<div id="start-mask">
    <h2>å®éªŒå‡†å¤‡å°±ç»ª</h2>
    <p style="margin: 10px 0; opacity: 0.7; font-size: 14px;">è¯·å¼€å¯æ‰‹æœºéŸ³é‡</p>
    <button id="start-btn">ç‚¹å‡»å¼€å§‹æµè§ˆ</button>
</div>

<div id="fullscreen-page-container">
    <div id="fullscreen-feed"></div>
</div>

<div class="floating-finish-btn" onclick="openModal()">âœ”<br>ç»“æŸ</div>

<div id="result-modal">
    <div class="modal-content">
        <div class="close-modal-btn" onclick="closeModal()">Ã—</div>
        <h3 style="margin-bottom:10px; margin-top:5px;">å®éªŒç»“æŸ</h3>
        <p style="font-size:13px; color:#666; margin-bottom:10px;">è¯·å¤åˆ¶ä¸‹æ–¹éªŒè¯ç å¹¶è¿”å›é—®å·ï¼š</p>
        <div class="code-box" id="code-display"></div>
        <button onclick="copyCode()" style="width:100%; padding:12px; background:#25D366; color:white; border:none; border-radius:8px; font-weight:bold;">å¤åˆ¶éªŒè¯ç </button>
    </div>
</div>

<script>
// --- 1. æ•°æ®å®šä¹‰ (å®Œæ•´ä¿ç•™æ‚¨çš„æ•°æ®) ---
const rawData = [
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%A4%A7%E7%90%863.mov", desc: "å¦‚æœå¯ä»¥ï¼Œä½ æƒ³å’Œè°ä¸€èµ·æ¥å¤§ç†å¹å¹é£ï¼ŸğŸŒ¬ï¸" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%A4%A7%E7%90%861.mov", desc: "è®²çœŸï¼Œçœ‹åˆ°è¿™ç‰‡äº‘ï¼Œä½ çš„å¿ƒæƒ…å˜å¥½äº†å—ï¼Ÿâ˜ï¸" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%A4%A7%E7%90%8610.mov", desc: "è¿™ç§æ…¢èŠ‚å¥çš„å¤é•‡ç”Ÿæ´»ï¼Œæ˜¯ä½ å‘å¾€çš„å—ï¼ŸğŸµ" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%A4%A7%E7%90%862.mov", desc: "ä½ æœ‰å¤šä¹…æ²¡æœ‰ç»™è‡ªå·±æ”¾ä¸ªå‡äº†ï¼Ÿâœˆï¸" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%A4%A7%E7%90%864.mov", desc: "çŒœçŒœè¿™æ˜¯å¤§ç†çš„å“ªä¸ªè§’è½ï¼Ÿå»è¿‡çš„ä¸¾æ‰‹ğŸ™‹" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%A4%A7%E7%90%865.MOV", desc: "è¿™ç§å¤©æ°”ï¼Œæœ€é€‚åˆå‘å‘†äº†ï¼Œä½ è§‰å¾—å‘¢ï¼Ÿâ˜€ï¸" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%A4%A7%E7%90%866.mov", desc: "å¦‚æœç”Ÿæ´»å¤ªç´¯ï¼Œå°±æ¥è¿™é‡Œèº²ä¸€èº²å§ğŸ " },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%A4%A7%E7%90%867.mov", desc: "è¿™é‡Œçš„æ—¥è½æ˜¯ä¸æ˜¯å¾ˆæ²»æ„ˆï¼ŸğŸŒ„" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%A4%A7%E7%90%868.MOV", desc: "å¬ï¼Œè¿™æ˜¯å¤§ç†çš„å£°éŸ³ï¼Œä½ å–œæ¬¢å—ï¼ŸğŸŒŠ" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%A4%A7%E7%90%869.mov", desc: "ç­”åº”æˆ‘ï¼Œè¿™è¾ˆå­ä¸€å®šè¦å»ä¸€æ¬¡å¤§ç†å¥½å—ï¼ŸğŸ¤" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%AE%A0%E7%89%A91.mov", desc: "å®ƒçš„çœ¼ç¥æœ‰æ²¡æœ‰èåŒ–ä½ çš„å¿ƒï¼Ÿå¤ªä¹–äº†ğŸ¥º" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%AE%A0%E7%89%A92.mov", desc: "æˆ‘å°±é—®ä¸€å¥ï¼Œè°èƒ½æ‹’ç»è¿™æ ·çš„å°ç‹—ï¼ŸğŸ¶" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%AE%A0%E7%89%A93.mov", desc: "ä¸Šç­ç´¯äº†ï¼Ÿçœ‹è¿™ä¸ªè§†é¢‘å›å›è¡€ğŸ”‹" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E5%AE%A0%E7%89%A94.mov", desc: "ä½ æ˜¯çŒ«æ´¾è¿˜æ˜¯ç‹—æ´¾ï¼Ÿè¯„è®ºåŒºå‘Šè¯‰æˆ‘ğŸ±ğŸ¶" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E6%89%8B%E5%B7%A51.mov", desc: "è¿™ç§ä¸“æ³¨çš„æ„Ÿè§‰ï¼Œä½ ç¾¡æ…•å—ï¼ŸğŸ§¶" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E6%89%8B%E5%B7%A52.mov", desc: "çŒœçŒœæœ€åæˆå“ä¼šæ˜¯ä»€ä¹ˆæ ·å­ï¼ŸğŸ¤”" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E6%89%8B%E5%B7%A53.mov", desc: "å‘¨æœ«å®…å®¶åšæ‰‹å·¥ï¼Œæ˜¯ä¸æ˜¯å¾ˆè§£å‹ï¼Ÿâœ‚ï¸" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E8%A7%A3%E5%8E%8B1.mov", desc: "å¼ºè¿«ç—‡è¡¨ç¤ºçœ‹å®Œè¿™ä¸ªè§†é¢‘æåº¦èˆ’é€‚ï¼âœ¨" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E8%A7%A3%E5%8E%8B2.mov", desc: "è¿™ç§ä¸æ»‘çš„æ„Ÿè§‰ï¼Œèƒ½ä¸èƒ½æ²»å¥½ä½ çš„ç²¾ç¥å†…è€—ï¼ŸğŸ§ " },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E8%A7%A3%E5%8E%8B3.mov", desc: "æ·±å¤œç¡ä¸ç€ï¼Ÿçœ‹è¿™ä¸ªè§†é¢‘åŠ©çœ å§ğŸ˜´" }
];
const adData = [
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E6%89%8B%E8%A1%A8.mov", desc: "éƒ½åœ¨é—®é“¾æ¥ï¼Ÿè¿™æ¬¾è¡¨çš„è®¾è®¡æ„ŸçœŸçš„ç»äº†âœ¨", adProduct: "W" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E6%B6%A6%E8%82%A4%E4%B9%B3.mov", desc: "æ¢å­£çš®è‚¤å¹²ç‡¥ï¼Ÿè¯•è¯•è¿™ä¸ªï¼Œäº²æµ‹å¥½ç”¨ï¼ğŸ’§", adProduct: "L" },
    { url: "https://gitee.com/ononon17/interface-layout/raw/master/%E6%89%8B%E6%9C%BA.mov", desc: "éšæ‰‹ä¸€æ‹å°±æ˜¯å¤§ç‰‡ï¼Œè¿™åƒç´ ä½ æ‰“å‡ åˆ†ï¼ŸğŸ“·", adProduct: "P" }
];

// --- 2. éšæœºæ´—ç‰Œ + å¹¿å‘Šé”å®š (é¡ºåºé€»è¾‘ä¼˜åŒ–) ---
function assembleVideoData() {
    // 1. å…ˆæŠŠå†…å®¹è§†é¢‘éšæœºæ‰“ä¹±ï¼Œä¿è¯å®éªŒéšæœºæ€§
    let contents = [...rawData];
    for (let i = contents.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [contents[i], contents[j]] = [contents[j], contents[i]];
    }
    
    // 2. æ’å…¥å¹¿å‘Šåˆ°å›ºå®šä½ç½® (index 5, 11, 17)
    let final = [];
    let cIdx = 0;
    for (let i = 0; i < 23; i++) {
        if (i === 5) final.push({...adData[0], type: "ad"}); 
        else if (i === 11) final.push({...adData[1], type: "ad"});
        else if (i === 17) final.push({...adData[2], type: "ad"});
        else {
            if (cIdx < contents.length) {
                final.push({...contents[cIdx++], type: "content"});
            }
        }
    }
    return final;
}
const videoData = assembleVideoData();

// --- 3. æ¸²æŸ“é¡µé¢ ---
const fsFeed = document.getElementById('fullscreen-feed');
const fsContainer = document.getElementById('fullscreen-page-container');
let fsVideoElements = [];

// åˆ›å»ºè§†é¢‘å…ƒç´ çš„å‡½æ•°
videoData.forEach((item, idx) => {
    const f = document.createElement('div');
    f.className = 'fs-video-item';
    f.id = `video-item-${idx}`;
    if(item.type === "ad") { f.dataset.isAd = "true"; f.dataset.product = item.adProduct; }
    
    // å…³é”®ä¼˜åŒ–ï¼šä½¿ç”¨ data-src è€Œé srcï¼Œå®ç°æ‡’åŠ è½½
    // playsinline, muted, loop æ˜¯æ ‡å‡†é…ç½®
    f.innerHTML = `
        <video data-src="${item.url}" loop playsinline webkit-playsinline x5-video-player-type="h5" x5-playsinline="true"></video>
        <div class="loading-spinner"></div>
        <div class="click-layer"></div>
        <div class="overlay"><div style="font-weight:700;margin-bottom:5px;">@ç”¨æˆ·_${1000+idx}</div><div>${item.desc}</div></div>
        <div class="sidebar-fs">
            <div class="icon-btn-fs heart-btn">â¤</div>
            <div class="icon-btn-fs comment-btn">ğŸ’¬</div>
            <div class="icon-btn-fs share-btn">ğŸ”—</div>
        </div>
    `;
    
    // åŸºç¡€äº¤äº’
    const video = f.querySelector('video');
    const spinner = f.querySelector('.loading-spinner');
    const heart = f.querySelector('.heart-btn');
    const clickLayer = f.querySelector('.click-layer');

    // ç›‘å¬åŠ è½½çŠ¶æ€
    video.addEventListener('waiting', () => { spinner.style.display = 'block'; });
    video.addEventListener('playing', () => { spinner.style.display = 'none'; });
    video.addEventListener('canplay', () => { spinner.style.display = 'none'; });

    // å•å‡»æš‚åœ/æ’­æ”¾ (ä¿ç•™æ‰‹åŠ¨æ§åˆ¶æƒ)
    clickLayer.onclick = () => {
        if (!video.src) return;
        if (video.paused) video.play();
        else video.pause();
    };

    heart.onclick = (e) => { e.stopPropagation(); heart.classList.toggle('liked'); };
    f.querySelector('.comment-btn').onclick = (e) => { e.stopPropagation(); alert("å®éªŒæ¨¡æ‹Ÿç¯å¢ƒæš‚ä¸æ”¯æŒå‘è¡¨è¯„è®ºã€‚"); };
    f.querySelector('.share-btn').onclick = (e) => { e.stopPropagation(); alert("é“¾æ¥å·²å¤åˆ¶ï¼Œåˆ†äº«åŠŸèƒ½ä»…ä¾›æ¨¡æ‹Ÿã€‚"); };

    fsFeed.appendChild(f);
    fsVideoElements.push(f);
});

// --- 4. é¡ºåºåŠ è½½ä¸è‡ªåŠ¨æœ‰å£°æ’­æ”¾æ§åˆ¶ (Core Logic) ---
let adStats = { "W": 0, "L": 0, "P": 0 };
let currentStart = 0;
let currentProd = null;
let isExperimentStarted = false; // æ˜¯å¦ç‚¹å‡»äº†å¼€å§‹æŒ‰é’®

// é¢„åŠ è½½å‡½æ•°ï¼šæŒ‰é¡ºåºè§¦å‘ä¸‹è½½
function preloadVideo(index) {
    if (index < 0 || index >= fsVideoElements.length) return;
    const item = fsVideoElements[index];
    const vid = item.querySelector('video');
    
    // åªæœ‰å½“æ²¡æœ‰ src æ—¶æ‰èµ‹å€¼ï¼Œé¿å…é‡å¤è¯·æ±‚
    if (!vid.getAttribute('src') && vid.dataset.src) {
        console.log("æ­£åœ¨é¢„åŠ è½½ç¬¬ " + (index+1) + " ä¸ªè§†é¢‘");
        vid.src = vid.dataset.src;
        vid.preload = "auto"; 
    }
}

// è§‚å¯Ÿè€…ï¼šå¤„ç†æ»‘åŠ¨æ’­æ”¾
const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
        const container = entry.target;
        const v = container.querySelector('video');
        const prod = container.dataset.product;
        const currentIndex = fsVideoElements.indexOf(container);

        if(entry.isIntersecting) {
            // 1. æ»‘å…¥å±å¹•ï¼šç¡®ä¿æœ‰é“¾æ¥
            if (!v.src) v.src = v.dataset.src;
            
            // 2. åªæœ‰åœ¨ç‚¹å‡»äº†â€œå¼€å§‹â€æŒ‰é’®åï¼Œæ‰å…è®¸æœ‰å£°æ’­æ”¾
            if (isExperimentStarted) {
                v.muted = false; // å¼€å¯å£°éŸ³
                v.play().catch(e => console.log("æ’­æ”¾å—é˜»ï¼Œå¯èƒ½æ˜¯äº¤äº’é—®é¢˜", e));
            }

            // 3. é¡ºåºé¢„åŠ è½½æœºåˆ¶ï¼š
            // å½“æˆ‘çœ‹ç¬¬Nä¸ªæ—¶ï¼Œç³»ç»Ÿç¡®ä¿ N+1 å’Œ N+2 å·²ç»å¼€å§‹ä¸‹è½½
            preloadVideo(currentIndex + 1);
            preloadVideo(currentIndex + 2);

            // ç»Ÿè®¡å¹¿å‘Š
            if(prod) { currentStart = Date.now(); currentProd = prod; }

        } else {
            // æ»‘å‡ºï¼šæš‚åœå¹¶é™éŸ³
            v.pause();
            v.muted = false; // ä¿æŒçŠ¶æ€ï¼Œæˆ–é‡ç½®
            v.currentTime = 0; // æ¨¡æ‹Ÿåˆ·è¿‡å»å°±é‡ç½®
            if(prod && currentProd === prod) {
                adStats[prod] += (Date.now() - currentStart);
                currentProd = null;
            }
        }
    });
}, { threshold: 0.6, root: fsContainer }); // 60%å¯è§æ‰æ’­æ”¾

fsVideoElements.forEach(el => observer.observe(el));

// --- 5. å¯åŠ¨æ§åˆ¶ (è§£å†³å£°éŸ³å’ŒåŠ è½½é—®é¢˜çš„å…³é”®) ---
document.getElementById('start-btn').addEventListener('click', function() {
    isExperimentStarted = true;
    document.getElementById('start-mask').style.display = 'none';
    
    // ç«‹å³å¤„ç†ç¬¬ä¸€ä¸ªè§†é¢‘
    const firstVid = fsVideoElements[0].querySelector('video');
    firstVid.src = firstVid.dataset.src;
    firstVid.muted = false; // æœ‰å£°
    firstVid.play();
    
    // ç«‹å³é¢„åŠ è½½åç»­
    preloadVideo(1);
    preloadVideo(2);
});

// --- 6. å¼¹çª—æ§åˆ¶ ---
function openModal() {
    // ç”Ÿæˆå‡æ•°æ®ç”¨äºæ¼”ç¤ºï¼Œå®é™…ä¼šè¯»å– adStats
    const code = `FIN-${Math.floor(Math.random()*9000)+1000}`;
    document.getElementById('code-display').innerText = code;
    document.getElementById('result-modal').style.display = 'flex';
    fsVideoElements.forEach(el => el.querySelector('video').pause());
}
function closeModal() {
    document.getElementById('result-modal').style.display = 'none';
}
function copyCode() {
    navigator.clipboard.writeText(document.getElementById('code-display').innerText);
    alert("éªŒè¯ç å·²å¤åˆ¶ï¼");
}
</script>
</body>
</html>